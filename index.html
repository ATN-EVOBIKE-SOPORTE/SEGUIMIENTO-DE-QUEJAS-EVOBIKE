<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EVOBIKE - Centro de Atenci√≥n</title>
    <style>
        :root { --primary: #003399; --success: #25d366; --error: #dc3545; --light: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: #e9ecef; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .container { background: white; width: 100%; max-width: 480px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; min-height: 250px; }
        .header { padding: 20px; text-align: center; border-bottom: 2px solid var(--light); }
        .header img { max-width: 140px; }
        .nav { display: flex; background: #eee; margin: 15px; border-radius: 12px; padding: 5px; }
        .nav-btn { flex: 1; border: none; padding: 10px; border-radius: 10px; cursor: pointer; font-weight: bold; color: #666; font-size: 11px; }
        .nav-btn.active { background: white; color: var(--primary); }
        .content { padding: 20px; display: none; }
        .content.active { display: block; }
        input, textarea { width: 100%; padding: 12px; margin-top: 8px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; background: var(--light); font-size: 14px; }
        label { font-size: 11px; font-weight: bold; color: #555; text-transform: uppercase; margin-top: 12px; display: block; }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 15px; color: white; transition: 0.3s; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn-primary { background: var(--primary); }
        .btn-success { background: var(--success); }
        #ticket-container { display: none; background: white; padding: 20px; border: 2px dashed #ccc; border-radius: 10px; margin-top: 20px; text-align: center; }
        .folio-grande { font-size: 28px; color: var(--primary); font-weight: bold; display: block; margin: 10px 0; border: 1px solid var(--primary); padding: 5px; border-radius: 8px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <img src="https://evobike.com.mx/cdn/shop/files/logo_600x.png?v=1614333552" alt="EVOBIKE">
    </div>

    <div class="nav" id="main-nav" style="display: none;">
        <button class="nav-btn" id="btn-tab-staff" onclick="showTab('tab-staff')">GENERAR QUEJA</button>
        <button class="nav-btn" id="btn-tab-consulta" onclick="showTab('tab-consulta')">CONSULTAR</button>
    </div>

    <div id="tab-staff" class="content">
        <h4 style="text-align:center; margin-top:0; color: var(--primary);">Registro de Nuevo Reporte</h4>
        <label>Nombre Cliente</label><input type="text" id="s-nombre" placeholder="Nombre completo">
        <label>WhatsApp</label><input type="number" id="s-tel" placeholder="10 d√≠gitos">
        <label>Sucursal</label><input type="text" id="s-sucursal" placeholder="Sucursal de venta">
        <label>Modelo</label><input type="text" id="s-modelo" placeholder="Ej. Evo S2">
        <label>Motivo</label><textarea id="s-obs" placeholder="Falla reportada"></textarea>
        <button class="btn btn-primary" onclick="generarLinkQueja()">GENERAR Y ENVIAR POR WHATSAPP</button>
    </div>

    <div id="tab-cliente-upload" class="content">
        <div id="form-cliente-area">
            <h3 id="msg-bienvenida" style="text-align:center; color:var(--primary); margin-top:0;"></h3>
            <label>Confirmar Sucursal</label>
            <input type="text" id="c-sucursal-cliente">
            <label style="color:var(--error); margin-top:15px;">Adjuntar P√≥liza o Nota (Obligatorio)</label>
            <input type="file" id="c-archivo" accept="image/*,application/pdf">
            <button class="btn btn-success" id="btn-finalizar" onclick="finalizarQueja()">FINALIZAR Y OBTENER FOLIO</button>
        </div>
        <div id="ticket-container">
            <h4 style="margin-top:0;">REPORTE REGISTRADO</h4>
            <span class="folio-grande" id="t-folio-big"></span>
            <p id="t-detalles" style="font-size: 13px; white-space: pre-line; text-align: left; background: #f9f9f9; padding: 10px; border-radius: 8px;"></p>
            <button class="btn btn-primary" onclick="window.print()">DESCARGAR TICKET</button>
        </div>
    </div>

    <div id="tab-consulta" class="content">
        <h4 style="text-align:center; margin-top:0;">Consultar Estatus</h4>
        <input type="text" id="q-folio" placeholder="EB-XXXX" style="text-align:center; text-transform:uppercase;">
        <button class="btn btn-primary" onclick="buscarStatus()">BUSCAR FOLIO</button>
        <div id="res-busqueda" style="display:none; margin-top:15px; padding:15px; background:#f9f9f9; border-radius:8px; border-left: 5px solid var(--primary); text-align: left;">
            <small>Estatus Actual:</small><br>
            <b id="r-status" style="color:var(--primary); font-size:16px;"></b><br><br>
            <small>Tiempo de Resoluci√≥n:</small><br>
            <b id="r-tiempo"></b>
        </div>
    </div>
</div>

<script>
    // URL DE LA IMPLEMENTACI√ìN DE GOOGLE (D√âJALA COMO EST√Å)
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxkvKjl7iPHCUeW2P3qLHwUvgzVD8aJhvV15qn8VGtgc7AvwNrOsniW0Vy6x90heYBd/exec";
    
    // DETECCI√ìN AUTOM√ÅTICA DE TU LINK DE GITHUB
    const PORTAL_URL = window.location.href.split('?')[0]; 

    function showTab(id) {
        const contents = document.getElementsByClassName('content');
        for (let i = 0; i < contents.length; i++) { contents[i].style.display = 'none'; }
        const buttons = document.getElementsByClassName('nav-btn');
        for (let i = 0; i < buttons.length; i++) { buttons[i].classList.remove('active'); }
        document.getElementById(id).style.display = 'block';
        if(document.getElementById('btn-'+id)) document.getElementById('btn-'+id).classList.add('active');
    }

    window.onload = function() {
        const p = new URLSearchParams(window.location.search);
        if (p.has('n')) {
            showTab('tab-cliente-upload');
            document.getElementById('msg-bienvenida').innerHTML = "Hola <b>" + p.get('n') + "</b>,<br>adjunta tu documentaci√≥n.";
            document.getElementById('c-sucursal-cliente').value = p.get('s') || "";
        } else if (p.has('staff')) {
            document.getElementById('main-nav').style.display = 'flex';
            showTab('tab-staff');
        } else {
            showTab('tab-consulta');
        }
    };

    function generarLinkQueja() {
        const n = document.getElementById('s-nombre').value;
        const t = document.getElementById('s-tel').value;
        const s = document.getElementById('s-sucursal').value;
        const m = document.getElementById('s-modelo').value;
        const o = document.getElementById('s-obs').value;
        if(!n || !t) { alert("Nombre y Tel√©fono son requeridos"); return; }
        
        const params = new URLSearchParams({ n: n, t: t, s: s, m: m, o: o });
        const linkOriginal = PORTAL_URL + "?" + params.toString();
        
        // MENSAJE INSTITUCIONAL DE EVOBIKE
        const msg = `üö≤ *EVOBIKE M√âXICO - Centro de Atenci√≥n*\n\n` +
                    `Estimado(a) *${n}*,\n` +
                    `Para dar seguimiento a la garant√≠a de su unidad *${m}*, es necesario completar su expediente digital en nuestro portal oficial:\n\n` +
                    `üîó CLIC AQU√ç PARA ADJUNTAR P√ìLIZA:\n${linkOriginal}\n\n` +
                    `_Este es un sistema automatizado para agilizar su reporte. Por favor, no responda a este mensaje._`;

        window.open(`https://wa.me/52${t}?text=${encodeURIComponent(msg)}`, '_blank');
    }

    async function finalizarQueja() {
        const file = document.getElementById('c-archivo').files[0];
        if(!file) { alert("La p√≥liza es obligatoria para generar el reporte."); return; }
        const btn = document.getElementById('btn-finalizar');
        btn.disabled = true; 
        btn.innerText = "Subiendo archivo...";
        const p = new URLSearchParams(window.location.search);
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = async () => {
            const folio = 'EB-' + Math.floor(1000 + Math.random() * 9999);
            const sucursalConfirmada = document.getElementById('c-sucursal-cliente').value;
            let obs = p.get('o') || "Sin observaciones";
            if(p.get('s') !== sucursalConfirmada) { obs += " [Nota: El cliente corrigi√≥ la sucursal]"; }
            const data = {
                folio: folio, 
                fecha: new Date().toLocaleDateString('es-MX'),
                nombre: p.get('n'), tel: p.get('t'), 
                sucursal: sucursalConfirmada, modelo: p.get('m'), 
                status: "Recibido / En Revisi√≥n", tiempo: "Por definir",
                observaciones: obs, archivoB64: reader.result
            };
            try {
                await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
                document.getElementById('form-cliente-area').style.display = 'none';
                document.getElementById('ticket-container').style.display = 'block';
                document.getElementById('t-folio-big').innerText = folio;
                document.getElementById('t-detalles').innerText = `‚Ä¢ Cliente: ${data.nombre}\n‚Ä¢ Unidad: ${data.modelo}\n‚Ä¢ Sucursal: ${data.sucursal}\n‚Ä¢ Fecha: ${data.fecha}`;
            } catch(e) {
                alert("Error de conexi√≥n. Intenta de nuevo.");
                btn.disabled = false; btn.innerText = "FINALIZAR Y OBTENER FOLIO";
            }
        };
    }

    async function buscarStatus() {
        const f = document.getElementById('q-folio').value.toUpperCase();
        if(!f) return;
        try {
            const r = await fetch(SCRIPT_URL + "?folio=" + f);
            const d = await r.json();
            if(d.error) { alert("Folio no encontrado."); return; }
            document.getElementById('res-busqueda').style.display = "block";
            document.getElementById('r-status').innerText = d.status;
            document.getElementById('r-tiempo').innerText = d.tiempo;
        } catch(e) { alert("Error al conectar con el servidor."); }
    }
</script>
</body>
</html>